# üöÄ Guide d‚Äôinstallation Guacamole 1.6.0 (Tomcat9 + MySQL)

## 0. Nettoyer l‚Äôexistant
sudo systemctl stop tomcat9 tomcat10 guacd
sudo apt purge tomcat* guacd -y
sudo apt autoremove -y
sudo rm -rf /etc/guacamole /var/lib/tomcat*/webapps/guacamole* /usr/share/tomcat*/webapps/guacamole*
sudo rm -rf /etc/tomcat*/Catalina/localhost/guacamole.xml

---

## 1. Installer les d√©pendances
sudo apt update
sudo apt install build-essential libcairo2-dev libjpeg-turbo8-dev libpng-dev \
libossp-uuid-dev libavcodec-dev libavutil-dev libswscale-dev freerdp2-dev \
libpango1.0-dev libssh2-1-dev libtelnet-dev libvncserver-dev libpulse-dev \
libssl-dev libvorbis-dev libwebp-dev mysql-server openjdk-17-jdk -y

‚ö†Ô∏è **Ne pas installer Tomcat10** ‚Üí on utilisera Tomcat9.

---

## 2. Installer Tomcat 9 manuellement
cd /tmp
wget https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.82/bin/apache-tomcat-9.0.82.tar.gz
tar -xvzf apache-tomcat-9.0.82.tar.gz
sudo mv apache-tomcat-9.0.82 /opt/tomcat9
sudo ln -s /opt/tomcat9 /opt/tomcat

---

## 3. Cr√©er un service systemd pour Tomcat9
sudo nano /etc/systemd/system/tomcat9.service

Contenu :
[Unit]
Description=Apache Tomcat 9
After=network.target

[Service]
Type=forking

Environment=JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
Environment=CATALINA_HOME=/opt/tomcat9
Environment=CATALINA_BASE=/opt/tomcat9
Environment=CATALINA_PID=/opt/tomcat9/tomcat.pid

ExecStart=/opt/tomcat9/bin/startup.sh
ExecStop=/opt/tomcat9/bin/shutdown.sh

User=www-data
Group=www-data
Restart=always

[Install]
WantedBy=multi-user.target

‚ö†Ô∏è V√©rifie que 'JAVA_HOME' correspond bien √† ton installation ('ls /usr/lib/jvm/' ‚Üí 'java-17-openjdk-amd64').

Applique les droits :
sudo chown -R www-data:www-data /opt/tomcat9
sudo chmod -R 755 /opt/tomcat9

Recharge systemd :
sudo systemctl daemon-reexec
sudo systemctl enable tomcat9
sudo systemctl start tomcat9

üëâ V√©rifie avec :
ps aux | grep tomcat

Tu dois voir '-Dcatalina.base=/opt/tomcat9' et '-Dcatalina.home=/opt/tomcat9'.

---

## 4. Installer Guacamole Server
cd /tmp
wget https://downloads.apache.org/guacamole/1.6.0/source/guacamole-server-1.6.0.tar.gz
tar -xvzf guacamole-server-1.6.0.tar.gz
cd guacamole-server-1.6.0
./configure
make
sudo make install
sudo ldconfig

Cr√©er un service systemd pour 'guacd' :
sudo nano /etc/systemd/system/guacd.service
[Unit]
Description=Guacamole proxy daemon (guacd)
After=network.target

[Service]
ExecStart=/usr/local/sbin/guacd -f
Restart=always
User=guacd
Group=guacd

[Install]
WantedBy=multi-user.target

si l'utilisateur guacd n'existe pas : sudo useradd -r -s /bin/false guacd
sudo systemctl daemon-reexec
sudo systemctl enable guacd
sudo systemctl start guacd
systemctl status guacd

---

## 5. Installer le client web
cd /tmp
wget https://downloads.apache.org/guacamole/1.6.0/binary/guacamole-1.6.0.war
sudo mv guacamole-1.6.0.war /opt/tomcat9/webapps/guacamole.war
sudo systemctl restart tomcat9

V√©rifie :
ls /opt/tomcat9/webapps/

Tu dois voir :

guacamole.war
guacamole/
ROOT

---

## 6. Configurer Guacamole
sudo mkdir -p /etc/guacamole/extensions /etc/guacamole/lib

sudo nano /etc/guacamole/guacamole.properties
guacd-hostname: localhost
guacd-port: 4822

# Si JDBC est utilis√© :
mysql-hostname: localhost
mysql-port: 3306
mysql-database: guacamole_db
mysql-username: guacamole_user
mysql-password: motdepasse

auth-provider: net.sourceforge.guacamole.net.auth.mysql.MySQLAuthenticationProvider

D√©finir la variable d‚Äôenvironnement :
sudo mkdir -p /etc/systemd/system/tomcat9.service.d
sudo nano /etc/systemd/system/tomcat9.service.d/guacamole.conf

Contenu :
[Service]
Environment=GUACAMOLE_HOME=/etc/guacamole

---

## 7. Configurer la base MySQL
sudo mysql
CREATE DATABASE guacamole_db;
CREATE USER 'guacamole_user'@'localhost' IDENTIFIED BY 'motdepasse';
GRANT ALL PRIVILEGES ON guacamole_db.* TO 'guacamole_user'@'localhost';
FLUSH PRIVILEGES;

Importer les sch√©mas SQL :
cat guacamole-auth-jdbc-1.6.0/mysql/schema/*.sql | mysql -u guacamole_user -p guacamole_db

---

## 8. D√©ployer le module JDBC
curl -O https://repo.maven.apache.org/maven2/org/apache/guacamole/guacamole-auth-jdbc-mysql/1.6.0/guacamole-auth-jdbc-mysql-1.6.0.jar
sudo cp guacamole-auth-jdbc-mysql-1.6.0.jar /etc/guacamole/extensions/

---

## 9. Alternative sans JDBC
sudo nano /etc/guacamole/user-mapping.xml
<user-mapping>
    <authorize username="admin" password="admin123" admin="true">
        <connection name="Test SSH">
            <protocol>ssh</protocol>
            <param name="hostname">127.0.0.1</param>
            <param name="port">22</param>
            <param name="username">guacamole</param>
        </connection>
    </authorize>
</user-mapping>

---

## 10. Lancer Guacamole
sudo systemctl daemon-reexec
sudo systemctl enable guacd
sudo systemctl start guacd
sudo systemctl restart tomcat9

Acc√®s : http://<IP_SERVEUR>:8080/guacamole/
Sans JDBC : 
admin
admin123

---

## ‚úÖ R√©sum√© corrig√©
- Guacamole 1.6.0 **n‚Äôest pas compatible avec Tomcat10** ‚Üí utiliser Tomcat9.  
- Ton erreur 404 venait du fait que Tomcat utilisait encore '/opt/tomcat3'.  
- Corrige le service systemd pour pointer vers '/opt/tomcat9'.  
- V√©rifie que 'ps aux | grep tomcat' montre bien '-Dcatalina.base=/opt/tomcat9'.  
- Ensuite, le '.war' sera d√©ploy√© et '/guacamole/' accessible.
