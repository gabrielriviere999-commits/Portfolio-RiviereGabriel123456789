# üöÄ Guide d‚Äôinstallation Guacamole 1.6.0 (Tomcat9 + MySQL)

## 0. Nettoyer l‚Äôexistant
sudo systemctl stop tomcat9 tomcat10 guacd
sudo apt purge tomcat* guacd -y
sudo apt autoremove -y
sudo rm -rf /etc/guacamole /var/lib/tomcat*/webapps/guacamole* /usr/share/tomcat*/webapps/guacamole*
sudo rm -rf /etc/tomcat*/Catalina/localhost/guacamole.xml

---

## 1. Installer les d√©pendances
sudo apt update
sudo apt install build-essential libcairo2-dev libjpeg-turbo8-dev libpng-dev \
libossp-uuid-dev libavcodec-dev libavutil-dev libswscale-dev freerdp2-dev \
libpango1.0-dev libssh2-1-dev libtelnet-dev libvncserver-dev libpulse-dev \
libssl-dev libvorbis-dev libwebp-dev mysql-server openjdk-17-jdk -y

‚ö†Ô∏è **Ne pas installer Tomcat10** ‚Üí on utilisera Tomcat9.

---

## 2. Installer Tomcat 9 manuellement
cd /tmp
wget https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.82/bin/apache-tomcat-9.0.82.tar.gz
tar -xvzf apache-tomcat-9.0.82.tar.gz
sudo mv apache-tomcat-9.0.82 /opt/tomcat9
sudo ln -s /opt/tomcat9 /opt/tomcat

---

## 3. Cr√©er un service systemd pour Tomcat9
sudo nano /etc/systemd/system/tomcat9.service

Contenu :
[Unit]
Description=Apache Tomcat 9
After=network.target

[Service]
Type=forking

Environment=JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
Environment=CATALINA_HOME=/opt/tomcat9
Environment=CATALINA_BASE=/opt/tomcat9
Environment=CATALINA_PID=/opt/tomcat9/tomcat.pid

ExecStart=/opt/tomcat9/bin/startup.sh
ExecStop=/opt/tomcat9/bin/shutdown.sh

User=www-data
Group=www-data
Restart=always

[Install]
WantedBy=multi-user.target

‚ö†Ô∏è V√©rifie que 'JAVA_HOME' correspond bien √† ton installation ('ls /usr/lib/jvm/' ‚Üí 'java-17-openjdk-amd64').

Applique les droits :
sudo chown -R www-data:www-data /opt/tomcat9
sudo chmod -R 755 /opt/tomcat9

Recharge systemd :
sudo systemctl daemon-reexec
sudo systemctl enable tomcat9
sudo systemctl start tomcat9

üëâ V√©rifie avec :
ps aux | grep tomcat

Tu dois voir '-Dcatalina.base=/opt/tomcat9' et '-Dcatalina.home=/opt/tomcat9'.

---

## 4. Installer Guacamole Server
cd /tmp
wget https://downloads.apache.org/guacamole/1.6.0/source/guacamole-server-1.6.0.tar.gz
tar -xvzf guacamole-server-1.6.0.tar.gz
cd guacamole-server-1.6.0
./configure
make
sudo make install
sudo ldconfig

Cr√©er un service systemd pour 'guacd' :
sudo nano /etc/systemd/system/guacd.service
[Unit]
Description=Guacamole proxy daemon (guacd)
After=network.target

[Service]
ExecStart=/usr/local/sbin/guacd -f
Restart=always
User=guacd
Group=guacd

[Install]
WantedBy=multi-user.target

si l'utilisateur guacd n'existe pas : sudo useradd -r -s /bin/false guacd
sudo systemctl daemon-reexec
sudo systemctl enable guacd
sudo systemctl start guacd
systemctl status guacd

---

## 5. Installer le client web
cd /tmp
wget https://downloads.apache.org/guacamole/1.6.0/binary/guacamole-1.6.0.war
sudo mv guacamole-1.6.0.war /opt/tomcat9/webapps/guacamole.war
sudo systemctl restart tomcat9

V√©rifie :
ls /opt/tomcat9/webapps/

Tu dois voir :

guacamole.war
guacamole/
ROOT

---

## 6. Configurer Guacamole
sudo mkdir -p /etc/guacamole/extensions /etc/guacamole/lib

sudo nano /etc/guacamole/guacamole.properties
guacd-hostname: localhost
guacd-port: 4822

# Si JDBC est utilis√© :
mysql-hostname: localhost
mysql-port: 3306
mysql-database: guacamole_db
mysql-username: guacamole_user
mysql-password: motdepasse
auth-provider: net.sourceforge.guacamole.net.auth.mysql.MySQLAuthenticationProvider

D√©finir la variable d‚Äôenvironnement :
sudo mkdir -p /etc/systemd/system/tomcat9.service.d
sudo nano /etc/systemd/system/tomcat9.service.d/guacamole.conf

Contenu :
[Service]
Environment=GUACAMOLE_HOME=/etc/guacamole

---

## 7. Configurer la base MySQL
sudo mysql
CREATE DATABASE guacamole_db;
CREATE USER 'guacamole_user'@'localhost' IDENTIFIED BY 'motdepasse';
GRANT ALL PRIVILEGES ON guacamole_db.* TO 'guacamole_user'@'localhost';
FLUSH PRIVILEGES;

Importer les sch√©mas SQL :
cd /tmp/guacamole-auth-jdbc-mysql-1.6.0/mysql/schema
cat guacamole-auth-jdbc-1.6.0/mysql/schema/*.sql | mysql -u guacamole_user -p guacamole_db

---

## 8. D√©ployer le module JDBC
curl -O https://repo.maven.apache.org/maven2/org/apache/guacamole/guacamole-auth-jdbc-mysql/1.6.0/guacamole-auth-jdbc-mysql-1.6.0.jar
sudo cp guacamole-auth-jdbc-mysql-1.6.0.jar /etc/guacamole/extensions/

---

## 9. Cr√©er un utilisateur Guacamole
‚ö†Ô∏è Ce n‚Äôest pas un compte MySQL, mais un compte Guacamole stock√© dans la table guacamole_user.
Exemple simple (mot de passe = compteA) :
INSERT INTO guacamole_user (username, password_hash, password_salt, disabled, expired)
VALUES ('compteA', UNHEX(SHA2('compteA', 256)), NULL, 0, 0);

Connexion web : compteA/compteA

---

## 10. Lancer Guacamole
sudo systemctl daemon-reexec
sudo systemctl enable guacd
sudo systemctl start guacd
sudo systemctl restart tomcat9

---

## 11. Alternative sans JDBC
sudo nano /etc/guacamole/user-mapping.xml
<user-mapping>
    <authorize username="compteA" password="compteA" admin="true">
        <connection name="Guacamole SSH">
            <protocol>ssh</protocol>
            <param name="hostname">127.0.0.1</param>
            <param name="port">22</param>
            <param name="username">guacamole</param>
        </connection>
    </authorize>
    <authorize username="compteB" password="compteB" admin="true">
        <connection name="Guacamole SSH">
            <protocol>ssh</protocol>
            <param name="hostname">127.0.0.1</param>
            <param name="port">22</param>
            <param name="username">guacamole</param>
        </connection>
    </authorize>

    <authorize username="compteA2" password="compteA" admin="true">
        <connection name="Debian SSH">
            <protocol>ssh</protocol>
            <param name="hostname">Adresse IP de la machine Debian</param>
            <param name="port">22</param>
            <param name="username">compteA</param>
        </connection>
    </authorize>
    <authorize username="compteB2" password="compteB" admin="true">
        <connection name="Debian SSH">
            <protocol>ssh</protocol>
            <param name="hostname">Adresse IP de la machine Debian</param>
            <param name="port">22</param>
            <param name="username">compteB</param>
        </connection>
    </authorize>    
</user-mapping>

---

Acc√®s : http://<IP_SERVEUR>:8080/guacamole/
Sans JDBC :
Pour la machine guacamole :
compteA/compteA ou compteB/compteB
puis le mot de passe de la machine guacamole.
Pour la machine Debian :
compteA2/compteA ou compteB2/compteB
puis le mot de passe de la machine Debian.

---

## ‚úÖ R√©sum√© corrig√©
- Guacamole 1.6.0 **n‚Äôest pas compatible avec Tomcat10** ‚Üí utiliser Tomcat9.  
- Ton erreur 404 venait du fait que Tomcat utilisait encore '/opt/tomcat3'.  
- Corrige le service systemd pour pointer vers '/opt/tomcat9'.  
- V√©rifie que 'ps aux | grep tomcat' montre bien '-Dcatalina.base=/opt/tomcat9'.  
- Ensuite, le '.war' sera d√©ploy√© et '/guacamole/' accessible.

---

## üîê Cr√©ation d‚Äôun utilisateur s√©curis√© dans guacamole_user

### 1. Choisir un mot de passe et un sel
- Mot de passe : MonSuperMotDePasse
- Sel : SelPersoUnique

Le sel est une cha√Æne al√©atoire que tu choisis pour renforcer la s√©curit√©.

---

### 2. G√©n√©rer le hash et le sel
Dans MySQL, on utilise SHA2 pour calculer le hash :

INSERT INTO guacamole_user (username, password_hash, password_salt, disabled, expired)
VALUES (
  'compteA',
  UNHEX(SHA2(CONCAT('MonSuperMotDePasse','SelPersoUnique'),256)),
  UNHEX(SHA2('SelPersoUnique',256)),
  0,
  0
);

---

### 3. V√©rifier l‚Äôinsertion
SELECT user_id, username FROM guacamole_user;
Tu dois voir ton utilisateur compteA.

---

### 4. Connexion dans l‚Äôinterface web
- **Utilisateur** : compteA  
- **Mot de passe** : MonSuperMotDePasse

Guacamole combine le mot de passe saisi avec le sel stock√© pour v√©rifier le hash.

---

## ‚úÖ R√©sum√©
- Les comptes Guacamole sont cr√©√©s dans la table guacamole_user.
- Utilise UNHEX(SHA2(CONCAT(password, salt),256)) pour le hash.
- Utilise UNHEX(SHA2(salt,256)) pour stocker le sel.
- Tu peux ensuite te connecter avec le mot de passe en clair que tu as choisi.
