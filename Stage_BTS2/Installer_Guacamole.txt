# Guide d’installation Guacamole 1.6.0 (Tomcat10 + MySQL)

## 0. Nettoyer l’existant
sudo systemctl stop tomcat9 tomcat10 guacd
sudo apt purge tomcat* guacd -y
sudo apt autoremove -y
sudo rm -rf /etc/guacamole /var/lib/tomcat*/webapps/guacamole* /usr/share/tomcat*/webapps/guacamole*
sudo rm -rf /etc/tomcat*/Catalina/localhost/guacamole.xml


---

## 1. Installer les dépendances
sudo apt update
sudo apt install build-essential libcairo2-dev libjpeg-turbo8-dev libpng-dev \
libossp-uuid-dev libavcodec-dev libavutil-dev libswscale-dev freerdp2-dev \
libpango1.0-dev libssh2-1-dev libtelnet-dev libvncserver-dev libpulse-dev \
libssl-dev libvorbis-dev libwebp-dev tomcat10 mysql-server -y


---

## 2. Installer Guacamole Server
wget https://downloads.apache.org/guacamole/1.6.0/source/guacamole-server-1.6.0.tar.gz
tar -xvzf guacamole-server-1.6.0.tar.gz
cd guacamole-server-1.6.0
./configure --with-init-dir=/etc/init.d
sudo make
sudo make install
sudo ldconfig


---

## 3. Installer le client web
wget https://downloads.apache.org/guacamole/1.6.0/binary/guacamole-1.6.0.war
sudo mv guacamole-1.6.0.war /var/lib/tomcat10/webapps/guacamole.war
sudo systemctl restart tomcat10


---

## 4. Configurer Guacamole
Créer le répertoire :
sudo mkdir -p /etc/guacamole/extensions /etc/guacamole/lib


sudo nano /etc/guacamole/guacamole.properties
properties
guacd-hostname: localhost
guacd-port: 4822

# Si JDBC est utilisé :
mysql-hostname: localhost
mysql-port: 3306
mysql-database: guacamole_db
mysql-username: guacamole_user
mysql-password: motdepasse

# Activer JDBC
auth-provider: net.sourceforge.guacamole.net.auth.mysql.MySQLAuthenticationProvider


Définir la variable d’environnement :
echo "GUACAMOLE_HOME=/etc/guacamole" | sudo tee -a /etc/default/tomcat10
sudo systemctl restart tomcat10


---

## 5. Configurer la base MySQL
sudo mysql
CREATE DATABASE guacamole_db;
CREATE USER 'guacamole_user'@'localhost' IDENTIFIED BY 'motdepasse';
GRANT ALL PRIVILEGES ON guacamole_db.* TO 'guacamole_user'@'localhost';
FLUSH PRIVILEGES;
exit


Importer les schémas SQL (si JDBC est présent) :
cd guacamole-auth-jdbc-1.6.0/mysql/schema
cat *.sql | mysql -u guacamole_user -p guacamole_db


---

## 6. Déployer le module JDBC
⚠️ Les `.jar` ne sont pas dans les archives source. Il faut récupérer l’archive **binaire JDBC**
(ou copier manuellement le `.jar` depuis Maven Central).  
Exemple :
sudo cp guacamole-auth-jdbc-mysql-1.6.0.jar /etc/guacamole/extensions/


---

## 7. Alternative sans JDBC (simple test)
Si tu veux tester sans base SQL, utilise `user-mapping.xml` :
mkdir -p /etc/guacamole
sudo nano /etc/guacamole/user-mapping.xml
<user-mapping>
    <authorize username="admin" password="admin123">
        <connection name="Serveur SSH">
            <protocol>ssh</protocol>
            <param name="hostname">192.168.1.10</param>
            <param name="port">22</param>
            <param name="username">root</param>
        </connection>
    </authorize>
</user-mapping>



Vérifier que `guacd` est installé
which guacd

Tu dois voir `/usr/local/sbin/guacd`.

Créer un service systemd pour `guacd`
Crée le fichier :
sudo nano /etc/systemd/system/guacd.service


Colle ceci :
ini
[Unit]
Description=Guacamole proxy daemon (guacd)
After=network.target

[Service]
ExecStart=/usr/local/sbin/guacd -f
Restart=always
User=guacd
Group=guacd

[Install]
WantedBy=multi-user.target

Créer l’utilisateur système
sudo useradd -r -s /bin/false guacd

Activer et démarrer le service
sudo systemctl daemon-reexec
sudo systemctl enable guacd
sudo systemctl start guacd

Vérifier
systemctl status guacd

---


## 8. Lancer Guacamole
sudo systemctl enable guacd
sudo systemctl start guacd
sudo systemctl restart tomcat10


Accès :  
`http://<IP_SERVEUR>:8080/guacamole`

---

## ✅ Résumé
- **Avec JDBC** → nécessite le `.jar` + schémas SQL.  
- **Sans JDBC** → fonctionne avec `user-mapping.xml` pour tester rapidement.  
- Les `.jar` ne sont pas dans les archives source → il faut les récupérer depuis l’archive binaire JDBC ou Maven Central.
