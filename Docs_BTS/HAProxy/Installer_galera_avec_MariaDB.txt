# üìò Documentation ‚Äì Cluster MariaDB Galera avec HAProxy

## 1. Objectif

Mettre en place un **cluster MariaDB Galera** hautement disponible avec :

* **2 n≈ìuds MariaDB** : `web1`, `web2`
* **1 HAProxy** pour l‚Äôacc√®s applicatif
* R√©plication **synchrone** des donn√©es
* Bascule automatique en cas de panne

---

## 2. Architecture

Clients / Applications
        |
     HAProxy
        |
+------------------+
| web1 | web2      |
| DB   | DB        |
| Galera Cluster   |
+------------------+

---

## 3. Pr√©requis

### OS

* Ubuntu 24.04 LTS

### Base de donn√©es

* MariaDB 10.11 (inclut Galera 4)

### R√©seau

* Les n≈ìuds doivent pouvoir communiquer sur :

  * TCP 3306 (MySQL)
  * TCP 4567 (r√©plication Galera)
  * TCP 4568 (IST)
  * TCP 4444 (SST)

---

## 4. Installation MariaDB + Galera

### Sur **web1** et **web2**

sudo apt update
sudo apt install mariadb-server galera-4 -y

V√©rification :

ls /usr/lib/galera/libgalera_smm.so

---

## 5. Configuration Galera

### Fichier

sudo nano /etc/mysql/mariadb.conf.d/60-galera.cnf

### Configuration commune

[galera]
wsrep_on=ON
wsrep_provider=/usr/lib/galera/libgalera_smm.so

wsrep_cluster_name="galera_cluster"
wsrep_cluster_address="gcomm://IP_WEB1,IP_WEB2"

binlog_format=ROW
default_storage_engine=InnoDB
innodb_autoinc_lock_mode=2

### Configuration sp√©cifique

#### web1

wsrep_node_name="web1"
wsrep_node_address="IP_WEB1"

#### web2

wsrep_node_name="web2"
wsrep_node_address="IP_WEB2"

---

## 6. D√©marrage du cluster (IMPORTANT)

### 6.1 Bootstrap du premier n≈ìud

Sur **web1 uniquement** :

sudo galera_new_cluster

---

### 6.2 D√©marrage du second n≈ìud

Sur **web2** :

sudo systemctl start mariadb

---

## 7. V√©rification du cluster

Sur chaque n≈ìud :
sudo mariadb

SHOW VARIABLES LIKE 'wsrep_on';
SHOW STATUS LIKE 'wsrep_cluster_size';
SHOW STATUS LIKE 'wsrep_cluster_status';
SHOW STATUS LIKE 'wsrep_local_state_comment';
SHOW STATUS LIKE 'wsrep_ready';

### R√©sultat attendu

| Variable                  | Valeur  |
| ------------------------- | ------- |
| wsrep_on                  | ON      |
| wsrep_cluster_size        | 2       |
| wsrep_cluster_status      | Primary |
| wsrep_local_state_comment | Synced  |
| wsrep_ready               | ON      |

---

## 8. Test de r√©plication

Sur **web1** :

CREATE DATABASE galera_test;

Sur **web2** :

SHOW DATABASES LIKE 'galera_test';

‚úÖ La base doit appara√Ætre imm√©diatement.

---

## 9. Probl√®mes connus / pi√®ges

### 9.1 `SHOW STATUS LIKE 'wsrep_on'` retourne `Empty set`

‚úîÔ∏è **Normal avec MariaDB 10.11**
üëâ Utiliser :

SHOW VARIABLES LIKE 'wsrep_on';

---

### 9.2 D√©marrage incorrect

‚ùå Ne jamais faire :

systemctl restart mariadb

pour le **premier d√©marrage du cluster**.

Toujours utiliser :

galera_new_cluster

---

## 10. Haute disponibilit√© ‚Äì Limitation actuelle

### ‚ö†Ô∏è Cluster √† 2 n≈ìuds

Risque de **split-brain** si un n≈ìud tombe.

### Solutions recommand√©es :

* Ajouter un **3·µâ n≈ìud Galera**
* OU ajouter **garbd (Galera Arbitrator)**

---

## 11. HAProxy (principe)

HAProxy :

* V√©rifie que le n≈ìud est :

  * `Primary`
  * `wsrep_ready = ON`
* Redirige uniquement vers les n≈ìuds sains

(Il ne stocke aucune donn√©e)

---

## 12. Commandes utiles

### Logs MariaDB

journalctl -u mariadb -n 100

### √âtat global

SHOW STATUS LIKE 'wsrep_%';

---

## 13. Bonnes pratiques

* Toujours arr√™ter les n≈ìuds **un par un**
* Toujours red√©marrer **un seul n≈ìud Galera √† la fois**
* Sauvegardes r√©guli√®res (Galera ‚â† backup)
* Surveiller `wsrep_cluster_size`

---

## 14. Conclusion

‚úî MariaDB Galera est **correctement install√©**
‚úî Le cluster est **fonctionnel et synchronis√©**
‚úî L‚Äôarchitecture est pr√™te pour HAProxy
‚ö† Ajouter un **3·µâ n≈ìud ou garbd** pour la production

