# Documentation – Cluster MariaDB Galera avec HAProxy

## 1. Objectif

Mettre en place un cluster MariaDB Galera hautement disponible avec :

* 2 nœuds MariaDB : web1, web2
* 1 HAProxy pour l’accès applicatif
* Réplication synchrone des données
* Bascule automatique en cas de panne

---

## 2. Architecture

Clients / Applications
        |
     HAProxy
        |
+------------------+
| web1 | web2      |
| DB   | DB        |
| Galera Cluster   |
+------------------+

---

## 3. Prérequis

### OS

* Ubuntu 24.04 LTS

### Base de données

* MariaDB 10.11 (inclut Galera 4)

### Réseau

* Les nœuds doivent pouvoir communiquer sur :

  * TCP 3306 (MySQL)
  * TCP 4567 (réplication Galera)
  * TCP 4568 (IST)
  * TCP 4444 (SST)

---

## 4. Installation MariaDB + Galera

### Sur web1 et web2

sudo apt update
sudo apt install mariadb-server galera-4 -y

Vérification :

ls /usr/lib/galera/libgalera_smm.so

---

## 5. Configuration Galera

### Fichier

sudo nano /etc/mysql/mariadb.conf.d/60-galera.cnf

### Configuration commune

[galera]
wsrep_on=ON
wsrep_provider=/usr/lib/galera/libgalera_smm.so

wsrep_cluster_name="galera_cluster"
wsrep_cluster_address="gcomm://IP_WEB1,IP_WEB2"

binlog_format=ROW
default_storage_engine=InnoDB
innodb_autoinc_lock_mode=2

### Configuration spécifique

#### web1

wsrep_node_name="web1"
wsrep_node_address="IP_WEB1"

#### web2

wsrep_node_name="web2"
wsrep_node_address="IP_WEB2"

---

## 6. Démarrage du cluster (IMPORTANT)

### 6.1 Bootstrap du premier nœud

Sur web1 uniquement :

sudo galera_new_cluster

---

### 6.2 Démarrage du second nœud

Sur web2 :

sudo systemctl start mariadb

---

## 7. Vérification du cluster

Sur chaque nœud :
sudo mariadb

SHOW VARIABLES LIKE 'wsrep_on';
SHOW STATUS LIKE 'wsrep_cluster_size';
SHOW STATUS LIKE 'wsrep_cluster_status';
SHOW STATUS LIKE 'wsrep_local_state_comment';
SHOW STATUS LIKE 'wsrep_ready';

### Résultat attendu

| Variable                  | Valeur  |
| ------------------------- | ------- |
| wsrep_on                  | ON      |
| wsrep_cluster_size        | 2       |
| wsrep_cluster_status      | Primary |
| wsrep_local_state_comment | Synced  |
| wsrep_ready               | ON      |

---

## 8. Test de réplication

Sur web1 :

CREATE DATABASE galera_test;

Sur web2 :

SHOW DATABASES LIKE 'galera_test';

La base doit apparaitre immédiatement.

---

## 9. Problèmes connus / pièges

### 9.1 SHOW STATUS LIKE 'wsrep_on' retourne Empty set

Normal avec MariaDB 10.11
Utiliser :
SHOW VARIABLES LIKE 'wsrep_on';

---

### 9.2 Démarrage incorrect

Ne jamais faire :
systemctl restart mariadb
pour le premier démarrage du cluster.

Toujours utiliser :
galera_new_cluster

---

## 10. Haute disponibilité – Limitation actuelle

### ⚠️ Cluster à 2 nœuds

Risque de split-brain si un nœud tombe.

### Solutions recommandées :

* Ajouter un 3ème nœud Galera
* OU ajouter garbd (Galera Arbitrator)

---

## 11. HAProxy (principe)

HAProxy :

* Vérifie que le nœud est :

  * Primary
  * wsrep_ready = ON
* Redirige uniquement vers les nœuds sains

(Il ne stocke aucune donnée)

---

## 12. Commandes utiles

### Logs MariaDB

journalctl -u mariadb -n 100

### État global

SHOW STATUS LIKE 'wsrep_%';

---

## 13. Bonnes pratiques

* Toujours arrêter les nœuds un par un
* Toujours redémarrer un seul nœud Galera à la fois
* Sauvegardes régulières (Galera ≠ backup)
* Surveiller wsrep_cluster_size

---

## 14. Conclusion

MariaDB Galera est correctement installé
Le cluster est fonctionnel et synchronisé
L’architecture est prête pour HAProxy
⚠️ Ajouter un 3ème nœud ou garbd pour la production

